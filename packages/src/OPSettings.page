Menu="Utilities"
Title="1Password Integration"
Icon="main-circle-small-icon.png"
Tag="key"
---
<?php
$pluginRoot = $pluginRoot ?? "{$docroot}/{$page['root']}";
define("OP_PLUGIN_ROOT", $pluginRoot);

require_once("$pluginRoot/include/Plugin.php");

$plugin = new Plugin();
?>
<script>
    const OP_PLUGIN_PATH = "<?= $plugin->get("webroot"); ?>";
    const OP_CONFIG = <?= json_encode($plugin->getConfig()->getAll(true)); ?>;
</script>
<!-- Load settings styles and scripts from the plugin -->
<?= $plugin->getStyle("settings"); ?>
<?= $plugin->getJavaScript("settings"); ?>
<!-- Load the file tree styles and scripts from the WebGui -->
<?= $plugin->getStyle("/webGui/styles/jquery.filetree.css?v=1700086926"); ?>
<?= $plugin->getJavaScript("/webGui/javascript/jquery.filetree.js?v=1700086926"); ?>

<div class="op-settings-wrapper">
    <!-- Main information -->
    <div class="top-information-wrapper">
        <blockquote class="inline_help" style="margin: 0px 25px 50px; display: none;">
            <h2>Instructions</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Phasellus et neque sed libero pellentesque fringilla.Nam lacinia urna dolor, vel sollicitudin dui pulvinar id. Nulla volutpat vitae neque quis aliquet.Quisque luctus tortor tristique orci elementum, vel eleifend lectus pellentesque. Curabitur commodo congue magna in tincidunt.Aliquam cursus lobortis purus ac condimentum. Vestibulum in maximus tortor. Nullam a blandit lectus, a gravida lacus.</p>
            <p>Aenean sit amet mauris luctus, imperdiet quam id,euismod lacus. Nunc condimentum, massa nec interdum efficitur, augue metus semper velit, in egestas dolor metus et metus. Aliquam fringilla consectetur eros in elementum. Praesent sit amet urna viverra, tempus quam quis, blandit leo. Mauris accumsan leo at leo volutpat tristique. Sed mollis odio ut ante elementum posuere. Cras luctus massa id odio euismod, sit amet aliquet libero sollicitudin.</p>
            <p>Curabitur eleifend mauris eget sapien bibendum, hendrerit elementum diam aliquam. Donec vel magna in tellus varius ullamcorper. Praesent viverra elit nulla, id tincidunt ante tempor ut. Donec congue purus vitae nibh bibendum, et posuere nisl cursus. Maecenas vitae varius erat. Nunc sit amet ex pulvinar, lacinia metus id, laoreet eros. Aliquam erat volutpat. Praesent eu ullamcorper lorem. Nullam elementum feugiat velit dignissim dignissim. Mauris malesuada, ante condimentum consequat ornare, tellus elit luctus elit, sed viverra tortor ipsum sed nisl. Nunc bibendum mi at sem ultricies rhoncus. Nam in velit erat. Phasellus viverra et orci fringilla sodales.</p>
        </blockquote>
    </div>

    <!-- SECTION: DOWNLOAD AND INSTALL THE CLI -->
    <section class="download-and-install-wrapper">
        <!-- Sub header -->
        <div class="sub-header-wrapper">
            <table class="tablesorter shift ups">
                <thead>
                    <tr>
                        <th>
                            <i class="fa fa-cloud-download" aria-hidden="true"></i> <span class="left">Download and install the 1Password cli</span>
                        </th>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- 1Password CLI Version -->
        <div class="1password-cli-version-wrapper">
            <dl>
                <dt style="cursor: help;"><strong>1Password cli version</strong>:</dt>
                <dd>
                    <span class="small"><strong>Installed: <span id="op_cli_latest_installed_version"></span></strong></span>
                    <span class="small">Latest: <span id="op_cli_latest_version_available"></span></span>
                    <span class="small">Stable: <span id="op_cli_latest_stable_version_available"></span></span>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>The currently installed, latest and stable 1Password cli version.</p>
            </blockquote>
        </div>

        <!-- Choose version to install -->
        <div class="choose-version-to-install-wrapper">
            <dl>
                <dt style="cursor: help;">Choose version/track to install:</dt>
                <dd>
                    <div class="select-with-custom-text-input">
                        <select class="align">
                            <option class="config-placeholder" value=""></option>
                            <option value="stable">Stable</option>
                            <option value="latest">Latest</option>
                            <option value="custom">Custom</option>
                            <option value="none">None</option>
                        </select>
                        <input type="text" class="small">
                        <input type="hidden" id="op_cli_version_track" name="op_cli_version_track">
                        <input type="submit" id="install_btn" name="install" value="Install">
                        <input type="button" id="check_for_updates" name="check_for_updates" value="Check for updates">
                    </div>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p><strong>stable</strong> (recommended): Will install the latest verified version. Verified compatibility with the plugin by the plugin author (version: 2.24.0).</p>
                <p><strong>latest</strong>: Will install the latest available release from AgileBits, 1Password (version: 2.30.0).</p>
                <p><strong>version number</strong>: Input the version number to install (e.g. version: 2.7.0 or 2.23.0-beta.01 or 2.30.0). This might break the plugin.</p>
                <p><strong>none</strong>: Set to none to uninstall the 1Password CLI from unRAID again.</p>
                <p>You can find all versions and the release notes for each version on
                    <a href="https://app-updates.agilebits.com/product_history/CLI2" target="_blank">1Passwords (AgileBits) website</a>
                </p>
            </blockquote>
        </div>

        <!-- Update automatically -->
        <div class="update-automatically-wrapper">
            <dl>
                <dt style="cursor: help;">Update automatically</dt>
                <dd>
                    <select id="op_cli_auto_update" name="op_cli_auto_update" class="align">
                        <option class="config-placeholder" value=""></option>
                        <option value="disabled">Disabled</option>
                        <option value="enabled">Enabled</option>
                    </select>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>Automatically install new versions of the 1Password CLI. The update installer will run on a daily basis.
                    Remember, automatic updates against the latest track might break the plugin. It's recommended to use the stable track!</p>
                <p>If <strong>latest</strong> track is selected the latest available update will be installed (only official releases, no betas).</p>
                <p>If <strong>stable</strong> track is selected the stable version specified by the plugin author will be installed.</p>
                </p>
            </blockquote>
        </div>

        <!-- Use 1Password CLI cache -->
        <div class="use-op-cache-wrapper">
            <dl>
                <dt style="cursor: help;">Use 1Password CLI cache</dt>
                <dd>
                    <select id="op_cli_use_cache" name="op_cli_use_cache" class="align">
                        <option class="config-placeholder" value=""></option>
                        <option value="false">Disabled</option>
                        <option value="true">Enabled</option>
                    </select>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>1Password CLI can use its daemon process to cache items, vault information, and the keys to access information in an account.</p>
                <p>The daemon stores encrypted information in memory using the same encryption methods as on 1Password.com. It can read the information to pass to 1Password CLI, but can't decrypt it.</p>
                <p>Caching between commands is enabled by default. This helps maximize performance and reduce the number of API calls.</p>
            </blockquote>
        </div>
    </section>

    <!-- SECTION: 1PASSWORD CLI SETTINGS -->
    <section class="general-settings-wrapper">
        <!-- Sub header -->
        <div class="sub-header-wrapper">
            <table class="tablesorter shift ups" style="margin-top:30px;">
                <thead>
                    <tr>
                        <th>
                            <i class="fa fa-cogs " aria-hidden="true"></i> <span class="left">General settings</span>
                        </th>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- Service account token -->
        <div class="service-account-token-wrapper">
            <dl>
                <dt style="cursor: help;">Service account token:</dt>
                <dd>
                    <div id="service_account_input_wrapper">
                        <input type="password" id="op_cli_service_account_token" name="op_cli_service_account_token" autocomplete="off" data-1p-ignore="" data-bwignore="" data-lpignore="true" data-form-type="other" style="min-width:35%">
                        <i class="fa fa-eye pwd-toggle" aria-hidden="true" title="Show value"></i>
                    </div>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p><strong>Note</strong>: This token will be stored on the flash drive in plain text.</p>
                <p>Make sure it only has limited access to your vaults. If the flash drive gets compromised you should invalidate the token immediately.</p>
                <p>More info about how to setup 1Password with a service account can be found at the
                    <a href="https://developer.1password.com/docs/service-accounts/get-started/" target="_blank">1Password's website</a>
                </p>
            </blockquote>
        </div>

        <!-- Export token to terminal -->
        <div class="export-token-to-terminal-wrapper">
            <dl>
                <dt style="cursor: help;">Export the service account token in the terminal</dt>
                <dd>
                    <select id="op_export_token_env" name="op_export_token_env" class="align">
                        <option class="config-placeholder" value=""></option>
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>
                    When this is enabled you will automatically get the environment variable OP_SERVICE_ACCOUNT_TOKEN exported
                    with the configured service account token for your 1Password service account.
                    This will enable you to run <em>op</em> commands directly by just opening up a terminal without any further
                    login hassle. Run <strong>op --help</strong> or visit <a href="https://developer.1password.com/docs/cli/reference" target="_blank">1Password's website</a> for more details.
                </p>
                <p>Example commands:</p>
                <ul>
                    <li><strong>op whoami</strong> (describes the current logged in user)</li>
                    <li><strong>op item list</strong> (lists all available items for the logged in user)</li>
                    <li><strong>op --help</strong> (displays information about available commands and flags)</li>
                    <li><strong>printenv</strong> (displays all exported environment variables, including OP_SERVICE_ACCOUNT_TOKEN if it has been enabled)</li>
                </ul>
                <p><strong>Note</strong>: Switchihng state for this setting will start/stop the export to any new session. But it will not handle any of the current terminal sessions. So you might need to restart the terminal for this setting to take effect.</p>
            </blockquote>
        </div>

        <!-- Mount encrypted disks with 1Password -->
        <div class="mount-encrypted-disks-wrapper">
            <dl>
                <dt style="cursor: help;">Mount encrypted disks with 1Password:</dt>
                <dd>
                    <select id="op_disk_mount" name="op_disk_mount" class="align">
                        <option class="config-placeholder" value=""></option>
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>
                    This will enable you to mount your disks from a 1Password vault item. Either manually or automatically on boot.
                    If this setting is enabled all other decryption methods will be disabled. This is because we'll hook into the starting event
                    of the array and replace the keyfile with the 1Password item.
                </p>
                <p>
                    If you changed your mind and don't want to use the 1Password vault item, you can easily revert this setting. Just set it to disabed
                    and you should be back to normal. You can also uninstall the entire plugin, but that's a bit overkill.
                </p>
                <p>
                    When this setting is enabled we will hook into the "starting" event hook. Fetch your 1Password item in the vault and copy it
                    into the default keyfile location (which is in RAM), if there already is a local keyfile it will be replaced.
                </p>
                <p>
                    If you have your keyfile/passphrase uploaded to your 1Password vault, the item is referenced correctly to your vault and you have an active internet connection
                    you should be able to decrypt your drive using 1Password.
                </p>
                <p>
                    <strong>Internet access is required</strong>, if you don't have any internet access from your server during the startup of the array
                    the startup will fail and you must manually start it again later or disable this setting and manually start the array with the decryption
                    keyfile/passphrase from a nother source.
                </p>
            </blockquote>
        </div>
    </section>

    <!-- SECTION: DISK ENCRYPTION SETTINGS -->
    <section class="disk-encryption-wrapper">
        <!-- Sub header -->
        <div class="sub-header-wrapper">
            <table class="tablesorter shift ups" style="margin-top:30px;">
                <thead>
                    <tr>
                        <th>
                            <i class="fa fa-database " aria-hidden="true"></i> <span class="left">Disk decryption</span>
                        </th>
                    </tr>
                </thead>
            </table>
        </div>

        <!-- Send notifications-->
        <div class="send-notifications-wrapper">
            <dl>
                <dt style="cursor: help;">§ Send notifications if any error occur during startup</dt>
                <dd>
                    <div class="alertContainer"><span>Select alert level:</span>
                        <select id="op_disk_alert_level" name="op_disk_alert_level">
                            <option class="config-placeholder" value=""></option>
                            <option value="alert">Alert</option>
                            <option value="warning">Warning</option>
                            <option value="notice">Notice</option>
                            <option value="none">Nothing</option>
                        </select>
                    </div>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>
                    This setting is mainly for you to decide how important the notification is for you. Some wish to have a simple notice, other wants to have big alarms
                    if the array doesn't start correctly. We recommend to turn it on, but which level is simply up to you and your other <a href="/Settings/Notifications">notification settings</a>.
                </p>
            </blockquote>
        </div>

        <!-- Delete local keyfile on mount -->
        <div class="delete-local-keyfile-wrapper">
            <dl>
                <dt style="cursor: help;">Delete local keyfile/passphrase when the disks are mounted</dt>
                <dd>
                    <select id="op_disk_delete_keyfile" name="op_disk_delete_keyfile" class="align">
                        <option class="config-placeholder" value=""></option>
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>
                    The keyfile is temporary stored in /root/keyfile during the time of mounting all disks.
                    Enable this setting to automatically delete it once the mounting is completed.
                </p>
                <p>
                    It's recommended to enable this feature to avoid leaking the key accidentally.
                    As long as we have an internet connection we can always re-fetch it from the 1Password vault when we need it.
                </p>
            </blockquote>
        </div>

        <!-- Choose vault item -->
        <div class="choose-vault-item-wrapper">
            <dl>
                <dt style="cursor: help;">Choose your vault item:</dt>
                <dd>
                    <div id="vault_item_wrapper">
                        <div id="op_file_tree_wrapper" style="display: none;">
                            <ul class="jqueryFileTree" style="display: block;"></ul>
                        </div>
                        <input id="op_vault_item" name="op_vault_item" type="text" style="display: inline-block;">
                        <input type="button" value="Browse" onclick="toggleVaultItemInputs()" title="Missing or invalid service account token, cannot browse. Update the token, save and then try again.">
                    </div>
                </dd>
            </dl>
            <blockquote class="inline_help">
                <p>
                    Choose the vault item you used to encrypt your disks. It's very important to be the exact same item,
                    otherwise the decryption won't work.
                </p>
                <p>
                    You can choose to either input the 1Password reference (starting with <code>op://</code>) as a text or selecting
                    the item in the tree view ("Browse"). It's recommended to use the "Browse" feature to make sure the
                    reference value is the correct one. The reference value usually follows these structures (square brackets indicates optional parameter):
                </p>
                <ul>
                    <li><code>op://&lt;vaultId&gt;/&lt;itemId&gt;/&lt;fieldId&gt;[?specialOption=value]</code></li>
                    <li><code>op://&lt;vaultId&gt;/&lt;itemId&gt;/[&lt;section&gt;/]&lt;fileId&gt;</code></li>
                </ul>
            </blockquote>
        </div>

        <!-- Validate decryption key test -->
        <div class="validate-key-test-wrapper">
            <dl>
                <dt style="cursor: help;">§ Validate selected key:</dt>
                <dd><input type="button" value="Test the decryption key"></dd>
            </dl>
            <blockquote class="inline_help">
                <p>This will validate if the selected key actually can decrypt the disks or not.</p>
                <p>If the validation fails we will print some debug information for you.</p>
            </blockquote>
        </div>
    </section>

    <hr>

    <!-- BOTTOM PAGE BUTTONS -->
    <section class="action-buttons-wrapper">
        <dl>
            <dt>&nbsp;</dt>
            <dd>
                <input type="button" id="apply_btn" value="Apply">
                <input type="button" id="restore_btn" value="Restore">
                <input type="button" id="default_btn" value="Default">
                <input type="button" id="close_btn" value="Close" onclick="done()">
            </dd>
        </dl>
    </section>
</div>
